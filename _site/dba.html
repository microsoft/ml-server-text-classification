<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <link rel="shortcut icon" type="image/png" href="images/favicon.png">
    <title>For the Database Analyst</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Use SQL Server 2017 + ML Services with Python to execute a transfer learning algorithm to detect image similarity.">
    <meta name="author" content="Microsoft">

    <!-- Le styles -->
    <link href="stylesheets/bootstrap.min.css" rel="stylesheet"/>

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="/js/html5shiv.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="stylesheets/mystyles.css">

  </head>
  <body> 
    <div class="container">
      <div class="row">
        <div class="col-sm-9">
          <div class="jumboton teal">
            <h1>Image Similarity</h1>
            <p>Implemented with Microsoft Machine Learning Services</p>
          </div>
              <div class="content">
                <h2 id="for-the-database-analyst---operationalize-with-sql">For the Database Analyst - Operationalize with SQL</h2>
<hr />

<div class="row">
    <div class="col-md-6">
        <div class="toc">
            <li><a href="#system-requirements">System Requirements</a></li>
            <li><a href="#workflow-automation">Workflow Automation</a></li>
            <li><a href="#step0">Step 0: Creating Tables</a></li>
            <li><a href="#step1">Step 1: Featurization of images with pre-trained DNN model</a></li>
            <li><a href="#step2">Step 2: Prepare training/testing/evaluation set</a></li>
            <li><a href="#step3">Step 3: Training multi-class classifier</a></li>
            <li><a href="#step4">Step 4: Evaluate model</a></li>
             <li><a href="#step5">Step 5: Ranking candidates for each query image</a></li>
        </div>
    </div>
    <div class="col-md-6">
              Microsoft Machine Learning Services provide an extensible, scalable platform for integrating machine learning tasks and tools with the applications that consume machine learning services. It includes a database service that runs outside the SQL Server process and communicates securely with R and Python. 
        <p>
       This solution package shows how to pre-process images (cleaning and feature engineering), train prediction models, and perform scoring on the SQL Server machine with stored procedures which includes Python code.  </p>
          </div>
</div>

<p>All the steps can be executed on SQL Server client environment (SQL Server Management Studio). We provide a Windows PowerShell script which invokes the SQL scripts and demonstrates the end-to-end modeling process.</p>

<h2 id="system-requirements">System Requirements</h2>
<hr />

<div class="highlighter-rouge"><pre class="highlight"><code>To run the scripts requires the following:
</code></pre>
</div>

<ul>
  <li>SQL Server 2017 with Machine Learning Services (In-Database) installed and configured</li>
  <li>The SQL user name and password, and the user configured properly to execute R scripts in-memory;</li>
  <li>SQL Database which the user has write permission and execute stored procedures;</li>
  <li>For more information about Machine Learning Services in SQL Server, please visit: <a href="https://msdn.microsoft.com/en-us/library/mt604847.aspx">https://msdn.microsoft.com/en-us/library/mt604847.aspx</a></li>
</ul>

<h2 id="workflow-automation">Workflow Automation</h2>
<hr />
<p>Follow the <a href="Powershell_Instructions.html">PowerShell instructions</a> to execute all the scripts described below.  <a href="tables.html">Click here</a> to view the SQL database tables created in this solution.</p>

<p>The SQL Stored procedure <code class="highlighter-rouge">Initial_Run_Once_Py</code> can be used to re-run steps 1-5 below.</p>

<p><a name="step0"></a></p>

<h3 id="step-0-creating-tables">Step 0: Creating Tables</h3>
<hr />

<h3 id="input">Input:</h3>

<ul>
  <li>Images in the directory <strong>C:\Solution\ImageSimilarity\data\fashionTexture</strong> are used to populate the FileTable created in this step</li>
</ul>

<h3 id="output">Output:</h3>

<ul>
  <li>ImageStore</li>
</ul>

<h3 id="example">Example:</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>EXEC CreateTables
</code></pre>
</div>

<p>Then copy images into the directory <code class="highlighter-rouge">\\computer-name\MSSQLSERVER\FileTableimages\ImageStore</code></p>

<p><a name="step1"></a></p>

<h2 id="step-1-featurization-of-images-with-pre-trained-dnn-model">Step 1: Featurization of images with pre-trained DNN model</h2>
<hr />
<p>This step generates features from the images using a pre-trained Resnet in <code class="highlighter-rouge">microsoftml</code>. The input is the FileTable <code class="highlighter-rouge">@image_table</code> which contains the images, the output is the SQL Table <code class="highlighter-rouge">@feature_table</code> which saves the images’ path, label,
and DNN features. The dimension of the features depends on which Resnet Model is used in this step. Here we used Resnet18 which generates 512-dimensional features for each image.
The stored procedure <code class="highlighter-rouge">FeaturizeImages</code> contains three steps:</p>

<ol>
  <li>
    <p>First, get the images path from the FileTable, map the distinct categories of all the images to factor labels.</p>
  </li>
  <li>
    <p>Second, get a label for each image based on the its category.</p>
  </li>
  <li>
    <p>Third, calculate the features using <code class="highlighter-rouge">microsoftml</code> library given the images path. You can find the code in <strong>image_similarity/image_similarity_utils.py</strong>.</p>
  </li>
</ol>

<h3 id="input-1">Input:</h3>
<ul>
  <li><code class="highlighter-rouge">ImageStore</code> table</li>
</ul>

<h3 id="output-1">Output:</h3>
<ul>
  <li><code class="highlighter-rouge">features</code> table</li>
</ul>

<h3 id="example-1">Example:</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>EXEC FeaturizeImages 'ImageStore', 'features'
</code></pre>
</div>

<p><a name="step2"></a></p>

<h2 id="step-2-prepare-trainingtestingevaluation-set">Step 2: Prepare training/testing/evaluation set</h2>
<hr />
<p>This step prepares the training/testing/evaluation image set. Here is the detail information about how to generate training/testing/evaluation set:</p>

<ol>
  <li>
    <p>Randomly split all the images into training/testing set based on category information and train/test ratio, users can change the parameter <code class="highlighter-rouge">@ratioTrainTest</code> according to the number of total images they have. For example, if the <code class="highlighter-rouge">@ratioTrainTest = 0.7</code>, then for each category, randomly select 70% images as training images and the left 30% images as testing images.</p>
  </li>
  <li>
    <p>Once the testing images were inserted into the SQL table, we generate evaluation image set based on testing images since we do not want to evaluation images overlap with the training images.</p>
  </li>
  <li>
    <p>Randomly select images from each category as query images, and then randomly select 1 positive image from the same category and some negative images from the other categories. So for each query image, we create 101 image pairs. Users also can set up parameter <code class="highlighter-rouge">@queryImagePerCat</code>
 to decide how many query images they want to select from each category, and set up parameter <code class="highlighter-rouge">@negImgsPerQueryImg</code> to decide how many negative images they want to select for each query image.</p>
  </li>
  <li>
    <p>For example, in this sample, we set up <code class="highlighter-rouge">@queryImagePerCat = 20</code> and <code class="highlighter-rouge">@negImgsPerQueryImg = 100</code>, finally, the evaluation set contains 220 query images since the image images contains 11 categories, and each query image has 101 candidates (1 positive image and 100 negative images).</p>
  </li>
</ol>

<h3 id="input-2">Input:</h3>
<ul>
  <li><code class="highlighter-rouge">features</code> table</li>
</ul>

<h3 id="output-2">Output:</h3>
<ul>
  <li><code class="highlighter-rouge">training_images</code> table</li>
  <li><code class="highlighter-rouge">testing_images</code> table</li>
  <li><code class="highlighter-rouge">evaluation_images</code> table</li>
  <li><code class="highlighter-rouge">@negImgsPerQueryImg</code></li>
</ul>

<h3 id="example-2">Example:</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>EXEC PrepareData 'features', 'training_images', 'testing_images', 'evaluation_images', 0.75, 20, 100
</code></pre>
</div>

<p><a name="step3"></a></p>

<h2 id="step-3-training-multi-class-classifier">Step 3: Training multi-class classifier</h2>
<hr />
<p>Once the features are computed, and the training images and testing images are inserted into the SQL table, we can use them to train a neural network model using <code class="highlighter-rouge">microsoftml</code> library and then save the model into SQL table.</p>

<ol>
  <li>
    <p>Get the DNN features for the training images and testing images from the feature table <code class="highlighter-rouge">@feature_table</code>, then train multi-class classifier using neural network algorithm in <code class="highlighter-rouge">microsoftml</code> library. Finally, evaluate the performance of the classifier using testing images.</p>
  </li>
  <li>
    <p>Overall accuracy is calculated to measure the performance of the classifier.</p>

    <table class="table">
     <thead>
         <tr>
             <th>Pre-trained model</th>
             <th>Classifier</th>
             <th>Accuracy on train set</th>
             <th>Accuracy on test set</th>
         </tr>
     </thead>
     <tbody>
         <tr>
             <td>Resnet18</td>
             <td>rx_neural_network</td>
             <td>89.7%</td>
             <td>75.1%</td>
         </tr>
     </tbody>
 </table>
  </li>
  <li>
    <p>Get the predicted scores of all the images in training and testing table using trained classifier, and save the predicted scores into SQL table <code class="highlighter-rouge">@scores_table</code>. Here we use all the images as the candidates for the last step. Users also can have their own candidate images. To get the predicted scores for users’ own candidate images, first, you have to featurize the candidate images using the pre-trained Resnet, and then load the classifier to calculate the predicted scores for your own candidate images.</p>
  </li>
</ol>

<h3 id="input-3">Input:</h3>
<ul>
  <li><code class="highlighter-rouge">features</code> table</li>
  <li><code class="highlighter-rouge">training_images</code> table</li>
  <li><code class="highlighter-rouge">testing_images</code> table</li>
</ul>

<h3 id="output-3">Output:</h3>
<ul>
  <li><code class="highlighter-rouge">scores</code> table</li>
  <li><code class="highlighter-rouge">model</code> table</li>
</ul>

<h3 id="example-3">Example:</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>EXEC TrainClassifier 'features', 'training_images', 'testing_images', 'scores', 'model'
</code></pre>
</div>

<p><a name="step4"></a></p>

<h2 id="step-4-evaluate-model">Step 4: Evaluate model</h2>
<hr />
<p>Once the model and the predicted scores of all the images are saved into SQL table, we can get the predicted scores from the <code class="highlighter-rouge">@scores_table</code> for all the image pairs in the evaluation table <code class="highlighter-rouge">@evaluation_table</code>. Based on the predicted scores, we can calculate the distance between each image pair to measure
their similarity so that we can evaluate the performance of the model in terms of ranking.</p>

<ol>
  <li>
    <p>Load the predicted scores for all the images, for example, in this sample, the image images contains 11 categories, so the predicted score is a 11-dimensional vector for each image.</p>
  </li>
  <li>
    <p>Load the image pairs from the evaluation table, for each image pair, we can get two 11-dimensional vectors, we calculate L2 and Cosine distance between these two vectors to measure the similarity. So for each image pair, we get two distances.</p>
  </li>
  <li>
    <p>We calculate top 1, 2, 4, 5, 8, 10, 15, 20, 28 and 32 accuracy to measure the ranking performance.</p>
  </li>
</ol>

<h3 id="input-4">Input:</h3>
<ul>
  <li><code class="highlighter-rouge">scores</code> table</li>
  <li><code class="highlighter-rouge">evaluation_images</code> table</li>
</ul>

<h3 id="output-4">Output:</h3>
<ul>
  <li>accuracy measures</li>
</ul>

<h3 id="example-4">Example:</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>EXEC EvaluateModel 'scores', 'evaluation_images'
</code></pre>
</div>

<p><a name="step5"></a></p>

<h2 id="step-5-ranking-candidates-for-each-query-image">Step 5: Ranking candidates for each query image</h2>
<hr />
<p>Once the accuracy of the image ranking system satisfy the requirement, we can rank the candidates for the query images.</p>

<ol>
  <li>
    <p>In order to get the similar images for each query image quickly, we have to make the predicted scores of all the candidate images ready before this step. We explained how to get the predicted scores for users’ own candidate images in step 3. So we assume
the predicted scores of all the candidate images are already saved in SQL table <code class="highlighter-rouge">@scores_table</code>, we just need to load the predicted scores for all the candidate images from the SQL table. We don’t need to calculate them in this step.</p>
  </li>
  <li>
    <p>Assume all the query images are already saved in SQL table <code class="highlighter-rouge">@query_table</code>. we load the query images from the SQL table, and then featurize the query images using pre-trained Resnet, here you have to used the same pre-trained model which used in the step 1.</p>
  </li>
  <li>
    <p>Load the model which trained in step 3 form SQL table <code class="highlighter-rouge">@model_table</code>, and calculate the predicted scores for all the query images using the model.</p>
  </li>
  <li>
    <p>Calculate the Cosine distance between each query image and all the candidates, based on the distance, return top K similar images for each query images. Users can set up parameter <code class="highlighter-rouge">@topKCandidates</code> to decide how many similar images should be returned for each query image.
 For example, here we set <code class="highlighter-rouge">@topKCandidates</code> equal to 10, so in the result table <code class="highlighter-rouge">@results_table</code>, each query image has 10 similar images.</p>
  </li>
</ol>

<h3 id="input-5">Input:</h3>
<ul>
  <li><code class="highlighter-rouge">@topKCandidates</code> - number of images to return for each input</li>
  <li><code class="highlighter-rouge">query_images</code> table</li>
  <li><code class="highlighter-rouge">scores</code> table</li>
  <li><code class="highlighter-rouge">model</code> table</li>
</ul>

<h3 id="output-5">Output:</h3>
<ul>
  <li>
    <ul>
      <li><code class="highlighter-rouge">ranking_results</code> table</li>
    </ul>
  </li>
</ul>

<h3 id="example-5">Example:</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>EXEC RankCandidates 10, 'query_images', 'scores', 'model', 'ranking_results'
</code></pre>
</div>


              </div>  
          </div><!--/col -->

        <div class="col-sm-3 sidebar-offcanvas" id="sidebar">
          <img  src="images/TextAnalysis.png">
          <div class="list-group">
          <a href="index.html" class="list-group-item">Home</a>
					<a href="data-scientist.html" class="list-group-item">For the Data Scientist</a>
          <a href="dba.html" class="list-group-item">For the Database Analyst</a>
					<a href="quick.html" class="list-group-item">Quick Start</a>
				  </div>
        <hr />
            <div class="center">
            <a  class="btn btn-large btn-info" href="https://github.com/Microsoft/ml-server-image-similarity">
            View On <strong>GitHub</strong></a>
            </div>
            <hr />
            <p class="details">Other Links</p>
              <div class="toc">
                <li><a href="contents.html">Packet Contents</a></li>
                <li><a href="sitemap.html">Site Map</a></li>

            </div>
          </div><!--/col -->
      </div><!-- /row -->

<div class="row">
  <hr />
      <footer>
        <p> 
This project has adopted the <a href="https://opensource.microsoft.com/codeofconduct/">Microsoft Open Source Code of Conduct</a>. For more information see the <a href="https://opensource.microsoft.com/codeofconduct/faq/">Code of Conduct FAQ</a> or contact <a href="mailto:opencode@microsoft.com">opencode@microsoft.com</a> with any additional questions or comments.</p>
        <p><small>Hosted on GitHub Pages</small> </p>
      </footer>
  </div>
  
</div><!-- /container -->

<script src="//ajax.aspnetcdn.com/ajax/jQuery/jquery-3.3.1.min.js"></script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-88854735-5', 'auto');
  ga('send', 'pageview');

</script>
    

  </body>
</html>